name: Compatibility Check

# ignore: RiskyTriggers
on:
  schedule:
    # Run daily at 00:00 UTC
    - cron: "0 0 * * *"
  workflow_dispatch:
    inputs:
      version_override:
        description: "Override the Flutter version to test against"
        required: false
        default: ""
        type: string

jobs:
  build_with_matrix:
    if: ${{ github.event_name == 'schedule' || github.event.inputs.version_override == '' }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        channel: ["stable", "beta"]

    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - uses: subosito/flutter-action@e938fdf56512cc96ef2f93601a5a40bde3801046 # v2.19.0
        with:
          channel: ${{ matrix.channel }}
          cache: true

      - name: Install Dependencies
        run: flutter packages get

      - name: Disable animations
        run: flutter config --no-cli-animations

      - name: Run tests
        run: |
          flutter test --no-pub --coverage --test-randomize-ordering-seed=random

      - name: Upload failures
        if: failure()
        uses: actions/upload-artifact@50769540e7f4bd5e21e526ee35c689e35e0d6874 # v4.4.0
        with:
          name: "golden_failures_${{ matrix.channel }}"
          path: |
            **/failures/**/*.png

      - name: Create job URL
        if: failure()
        id: create-job-url
        run: |
          echo "job_url=${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> "$GITHUB_OUTPUT"

      - name: Notify failure
        if: failure()
        uses: slackapi/slack-github-action@b0fa283ad8fea605de13dc3f449259339835fc52 # v2.1.0
        with:
          webhook-type: webhook-trigger
          webhook: ${{ secrets.MOBILE_OSS_SLACK_WEBHOOK }}
          payload: |
            text: "Alchemist smoke tests failed on the ${{ matrix.channel }} channel. Check them out and determine root cause: ${{ steps.create-job-url.outputs.job_url }}"
            blocks:
              - type: "section"
                text:
                  type: "mrkdwn"
                  text: "Alchemist smoke tests failed on the `${{ matrix.channel }}` channel. Check them out and determine root cause. <${{ steps.create-job-url.outputs.job_url }}|Job URL>"

  build_with_override:
    if: ${{ github.event.inputs.version_override != '' }}
    runs-on: ubuntu-latest

    steps:
      - name: Validate version format
        env:
          VERSION: ${{ github.event.inputs.version_override }}
        run: |
          # Validate semver format including pre-release versions like 3.37.0-0.1.pre
          # This regex matches standard semver including pre-release and build metadata
          if ! echo "$VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+(-[0-9A-Za-z\-\.]+)?(\+[0-9A-Za-z\-\.]+)?$'; then
            echo "Error: Invalid version format. Version must be a valid semver string (e.g., 3.37.0 or 3.37.0-0.1.pre)"
            echo "Provided version: $VERSION"
            exit 1
          fi
          echo "âœ“ Version format validated: $VERSION"

      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - uses: subosito/flutter-action@e938fdf56512cc96ef2f93601a5a40bde3801046 # v2.19.0
        with:
          flutter-version: ${{ github.event.inputs.version_override }}
          channel: any
          cache: true

      - name: Install Dependencies
        run: flutter packages get

      - name: Disable animations
        run: flutter config --no-cli-animations

      - name: Run tests
        run: |
          flutter test --no-pub --coverage --test-randomize-ordering-seed=random

      - name: Upload failures
        if: failure()
        uses: actions/upload-artifact@50769540e7f4bd5e21e526ee35c689e35e0d6874 # v4.4.0
        with:
          name: "golden_failures_${{ github.event.inputs.version_override }}"
          path: |
            **/failures/**/*.png

      - name: Create job URL
        if: failure()
        id: create-job-url
        run: |
          echo "job_url=${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> "$GITHUB_OUTPUT"
